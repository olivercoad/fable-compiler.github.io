<html class="has-navbar-fixed-top" lang="en"><head><title>Fable · Announcing Nagareyama (Fable 3) (II)</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/style.css"/><script src="https://unpkg.com/scroll-into-view-if-needed@2.2.28/umd/scroll-into-view-if-needed.min.js"></script></head><body><nav class="navbar is-fixed-top is-spaced"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/">Fable</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/docs">Documentation</a><a class="navbar-item is-hidden-mobile" href="/repl/">Try</a><a class="navbar-item is-active" href="/blog/index.html">Blog</a><a class="navbar-item is-hidden-mobile" href="/community.html">Community</a><a class="navbar-item is-hidden-mobile" href="/resources.html">Resources</a><div class="navbar-item navbar-burger-dots is-hidden-tablet"><svg height="4" stroke="none" viewBox="0 0 22 4" width="22"><circle cx="2" cy="2" r="2"></circle><circle cx="2" cy="2" r="2" transform="translate(9,0)"></circle><circle cx="2" cy="2" r="2" transform="translate(18,0)"></circle></svg></div></div><div class="navbar-end is-hidden-mobile"><a class="navbar-item" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a></div></div><div class="nacara-navbar-menu"><a class="nacara-navbar-menu-item" href="/repl/">Try</a><a class="nacara-navbar-menu-item" href="/community.html">Community</a><a class="nacara-navbar-menu-item" href="/resources.html">Resources</a><a class="nacara-navbar-menu-item" href="https://github.com/fable-compiler/fable">Github</a><a class="nacara-navbar-menu-item" href="https://twitter.com/FableCompiler">Twitter</a><a class="nacara-navbar-menu-item" href="https://gitter.im/fable-compiler/Fable">Gitter</a><a class="nacara-navbar-menu-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos">Youtube</a></div></div></nav><div class="grey-overlay"></div><div class="nacara-content"><div class="container"><div class="columns"><div class="column is-8-desktop is-offset-2-desktop"><div class="section blog-post"><figure class="image is-96x96 author-image"><img class="is-rounded" src="https://github.com/alfonsogarciacaro.png"/></figure><h2 class="title is-size-3 has-text-primary has-text-weight-normal has-text-centered blog-title">Announcing Nagareyama (Fable 3) (II)</h2><div class="tags has-addons is-justify-content-center"><a class="tag is-rounded is-medium is-primary" href="https://twitter.com/alfonsogcnunez">Alfonso García-Caro</a><span class="tag is-rounded is-medium">November 7, 2020</span></div><div class="content"><style class=grvsc-styles>.grvsc-container{overflow:auto;position:relative;-webkit-overflow-scrolling:touch;padding-top:1rem;padding-top:var(--grvsc-padding-top,var(--grvsc-padding-v,1rem));padding-bottom:1rem;padding-bottom:var(--grvsc-padding-bottom,var(--grvsc-padding-v,1rem));border-radius:8px;border-radius:var(--grvsc-border-radius,8px);font-feature-settings:normal;line-height:1.4}.grvsc-code{display:table}.grvsc-line{display:table-row;box-sizing:border-box;width:100%;position:relative}.grvsc-line>*{position:relative}.grvsc-gutter-pad{display:table-cell;padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-gutter{display:table-cell;-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter::before{content:attr(data-content)}.grvsc-source{display:table-cell;padding-left:1.5rem;padding-left:var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem));padding-right:1.5rem;padding-right:var(--grvsc-padding-right,var(--grvsc-padding-h,1.5rem))}.grvsc-source:empty::after{content:' ';-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter+.grvsc-source{padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-has-line-highlighting>.grvsc-code>.grvsc-line::before{content:' ';position:absolute;width:100%}.grvsc-line-diff-add::before{background-color:var(--grvsc-line-diff-add-background-color,rgba(0,255,60,.2))}.grvsc-line-diff-del::before{background-color:var(--grvsc-line-diff-del-background-color,rgba(255,0,20,.2))}.grvsc-line-number{padding:0 2px;text-align:right;opacity:.7}.atom-one-light{background-color:#fafafa;color:#383a42}.atom-one-light .mtk14{color:#a626a4}.atom-one-light .mtk1{color:#383a42}.atom-one-light .mtk5{color:#e45649}.atom-one-light .mtk9{color:#4078f2}.atom-one-light .mtk6{color:#986801}.atom-one-light .mtk8{color:#0184bc}.atom-one-light .mtk4{color:#c18401}.atom-one-light .grvsc-line-highlighted::before{background-color:var(--grvsc-line-highlighted-background-color,rgba(0,0,0,.05));box-shadow:inset var(--grvsc-line-highlighted-border-width,4px) 0 0 0 var(--grvsc-line-highlighted-border-color,rgba(0,0,0,.2))}</style><p>I hope you already tried out the new Fable and are enjoying it! If you haven't yet, please note the release candidate has just been published. This means we are focusing now on fixing bugs and there won't be any major change before the stable release. This is the perfect opportunity to try upgrading your app and check everything is working correctly (if it doesn't, <a href=https://github.com/fable-compiler/Fable/issues/new>let us know</a>). Be confident Nagareyama has already been tested in different production apps and we have already ironed out most (if not all) issues. To install Fable 3 just run the following command (use <code>update</code> instead of <code>install</code> if you already installed the tool previously):<pre class="atom-one-light grvsc-container"data-index=0 data-language><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source>dotnet tool install fable --version "3.0.0-nagareyama-*"</span></span></code></pre><p>To upgrade an existing app using Webpack, check <a href=https://github.com/MangelMaxime/fulma-demo/pull/43>this guide as reference</a>.<p>In this post we will also dive into the differences when generating JS code compared to Fable 2.<h2>The good news</h2><p>The good news is Nagareyama aims to bring <strong>no code breaking changes</strong>. Besides the tooling updates described in the <a href=https://fable.io/blog/Announcing-Nagareyama-1.html>previous post</a>, your app should work as is when upgrading Fable!<p>However, it may happen your code relied on a specific and not documented implementation detail of Fable 2. In that case, please report to us to check if that is an actual regression or whether we can advise you how to adapt your code.<h2>And the not-so-good news</h2><p>As we saw in the previous post, the main change in Nagareyama is the removal of the Babel dependency. Unfortunately, one thing Babel did for us and we couldn't implement yet is the <a href=https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map>source-maps</a> (which let you debug the F# code in the browser or in VS Code instead of the generated JS). If you relied on source-maps when programming with Fable, please help us <a href=https://github.com/fable-compiler/Fable/issues/2166>bring them back</a>.<h2>Better name-mangling</h2><p>To compensate the lack of source-maps, when implementing our own JS printers we've also tried to make the generated JS code "prettier" so it's more readable and easier to debug directly. A very important point was the mangling of value names, necessary as in JS we cannot <em>shadow</em> values as we do in F#. Fable 2 was not very subtle here: firstly, it generated unique names <em>per file</em>, so functions arguments where mangled even if they didn't conflict in the local scope; and secondly, it used the <code>$</code> character (legal in JS but not in F# unless you use quotes) quite aggressively making the code more difficult to read. Nagareyama fixes this by using member scope instead and reducing the use of the dollar sign.<p>A simple example can be seen here. This is how Fable 2 compiled the following function:<pre class="atom-one-light grvsc-container"data-index=1 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>map3</span><span class=mtk1> f xs ys zs </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    fold3 </span><span class=mtk14>(fun</span><span class=mtk1> acc x y z </span><span class=mtk14>-></span><span class=mtk1> f x y z</span><span class=mtk14>::</span><span class=mtk1>acc</span><span class=mtk14>)</span><span class=mtk1> </span><span class=mtk14>[]</span><span class=mtk1> xs ys zs</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>|></span><span class=mtk1> reverse</span></span></span></code></pre><pre class="atom-one-light grvsc-container"data-index=2 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>mapIndexed3</span><span class=mtk1>(f$$21, xs$$42, ys$$14, zs$$4) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>const</span><span class=mtk1> </span><span class=mtk6>xs$$43</span><span class=mtk1> </span><span class=mtk8>=</span><span class=mtk1> </span><span class=mtk9>foldIndexed3</span><span class=mtk1>(</span><span class=mtk14>function</span><span class=mtk1> (i$$6, acc$$16, x$$22, y$$7, z$$3) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>return</span><span class=mtk1> </span><span class=mtk14>new</span><span class=mtk1> </span><span class=mtk4>List</span><span class=mtk1>(</span><span class=mtk9>f$$21</span><span class=mtk1>(i$$6, x$$22, y$$7, z$$3), acc$$16);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  }, </span><span class=mtk14>new</span><span class=mtk1> </span><span class=mtk4>List</span><span class=mtk1>(), xs$$42, ys$$14, zs$$4);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> </span><span class=mtk9>reverse</span><span class=mtk1>(xs$$43);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span></code></pre><p>The same function compiled with Nagareyama results in much cleaner code:<pre class="atom-one-light grvsc-container"data-index=3 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>mapIndexed3</span><span class=mtk1>(f, xs, ys, zs) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>const</span><span class=mtk1> </span><span class=mtk6>xs_1</span><span class=mtk1> </span><span class=mtk8>=</span><span class=mtk1> </span><span class=mtk9>foldIndexed3</span><span class=mtk1>((i, acc, x, y, z) </span><span class=mtk14>=></span><span class=mtk1> (</span><span class=mtk14>new</span><span class=mtk1> </span><span class=mtk4>List</span><span class=mtk1>(</span><span class=mtk9>f</span><span class=mtk1>(i, x, y, z), acc)), </span><span class=mtk14>new</span><span class=mtk1> </span><span class=mtk4>List</span><span class=mtk1>(), xs, ys, zs);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>return</span><span class=mtk1> </span><span class=mtk9>reverse</span><span class=mtk1>(xs_1);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span></code></pre><h2>JS classes</h2><p>By default, Fable 2 used JS function constructors and prototype inheritance, though there was a compiler flag (rarely used) to generate ES2015 classes instead. In Fable 3 this is the default now (the only one option indeed), which makes the code more recognizable both to programmers (the C#-like class syntax is very extended) and to JS tooling.<p>Please note however, class members are still implemented as static functions (with a hash suffix to disambiguate overloads). This is the way F# actually compiles the code, and it also plays better with tree shaking and results in more perfomant code because JIT JS compilers can link the calls statically.<h2>Improvements in fable-library</h2><p>We've made several improvements to the fable-library (containing the code Fable uses to replace calls to BCL/FSharp.Core). The biggest one being the inclusion of the new implementation of <a href=https://github.com/dotnet/fsharp/pull/10188>F# Map and Set in FSharp.Core</a> by Victor Baybekov. This brings a huge performance improvement to these immutable collections (they will be noticeably only if your app makes heavy use of Map and/or Set though). Fable's mysterious contributor, <a href=https://github.com/ncave>ncave</a>, is also working on a new implementation for immutable lists that hopefully can make it into Fable 3.0 or 3.1.<h2>Prevent V8 deoptimizations</h2><p>If you are somewhat familiar with how JS engines work and in particular V8, the most ubiquitous one, you probably know the JS performance-killers are deoptimizations: that is, when the engine makes an assumption about a function and generates optimized code for that, to later realize the function is being called in a different way than expected (we all know how many weird ways there are to run JS code).<p>There was already a big leap in the performance of the generated JS code when moving from Fable 1 to Fable 2, so this time there were not many obvious opportunities for optimization. However, ncave and <a href=https://github.com/chrisvanderpennen>Chris van der Pennen</a> have been working hard to identify the remaining ones, like stack traces in custom exceptions or getters in object literals, in order to fix them and make sure the JS code generated by Nagareyam doesn't include any performance pitfall.</p><br><p>That was all, folks. We are very close to the stable Fable 3 version so please help us identify the remaining issues by giving the release candidate a go. In the next posts we will review the actual new features in Nagareyama (not so many) and go into more detail about the speed improvements in the compiler itself.</div></div></div></div></div></div><script async="" src="/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>