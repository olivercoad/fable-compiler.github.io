<html class="has-navbar-fixed-top" lang="en"><head><title>Fable · Tree Shaking with Fable</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/style.css"/><script src="https://unpkg.com/scroll-into-view-if-needed@2.2.28/umd/scroll-into-view-if-needed.min.js"></script></head><body><nav class="navbar is-fixed-top is-spaced"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/">Fable</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/docs">Documentation</a><a class="navbar-item is-hidden-mobile" href="/repl/">Try</a><a class="navbar-item is-active" href="/blog/index.html">Blog</a><a class="navbar-item is-hidden-mobile" href="/community.html">Community</a><a class="navbar-item is-hidden-mobile" href="/resources.html">Resources</a><div class="navbar-item navbar-burger-dots is-hidden-tablet"><svg height="4" stroke="none" viewBox="0 0 22 4" width="22"><circle cx="2" cy="2" r="2"></circle><circle cx="2" cy="2" r="2" transform="translate(9,0)"></circle><circle cx="2" cy="2" r="2" transform="translate(18,0)"></circle></svg></div></div><div class="navbar-end is-hidden-mobile"><a class="navbar-item" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a></div></div><div class="nacara-navbar-menu"><a class="nacara-navbar-menu-item" href="/repl/">Try</a><a class="nacara-navbar-menu-item" href="/community.html">Community</a><a class="nacara-navbar-menu-item" href="/resources.html">Resources</a><a class="nacara-navbar-menu-item" href="https://github.com/fable-compiler/fable">Github</a><a class="nacara-navbar-menu-item" href="https://twitter.com/FableCompiler">Twitter</a><a class="nacara-navbar-menu-item" href="https://gitter.im/fable-compiler/Fable">Gitter</a><a class="nacara-navbar-menu-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos">Youtube</a></div></div></nav><div class="grey-overlay"></div><div class="nacara-content"><div class="container"><div class="columns"><div class="column is-8-desktop is-offset-2-desktop"><div class="section blog-post"><figure class="image is-96x96 author-image"><img class="is-rounded" src="https://github.com/alfonsogarciacaro.png"/></figure><h2 class="title is-size-3 has-text-primary has-text-weight-normal has-text-centered blog-title">Tree Shaking with Fable</h2><div class="tags has-addons is-justify-content-center"><a class="tag is-rounded is-medium is-primary" href="https://twitter.com/alfonsogcnunez">Alfonso García-Caro</a><span class="tag is-rounded is-medium">November 30, 2016</span></div><div class="content"><style class=grvsc-styles>.grvsc-container{overflow:auto;position:relative;-webkit-overflow-scrolling:touch;padding-top:1rem;padding-top:var(--grvsc-padding-top,var(--grvsc-padding-v,1rem));padding-bottom:1rem;padding-bottom:var(--grvsc-padding-bottom,var(--grvsc-padding-v,1rem));border-radius:8px;border-radius:var(--grvsc-border-radius,8px);font-feature-settings:normal;line-height:1.4}.grvsc-code{display:table}.grvsc-line{display:table-row;box-sizing:border-box;width:100%;position:relative}.grvsc-line>*{position:relative}.grvsc-gutter-pad{display:table-cell;padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-gutter{display:table-cell;-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter::before{content:attr(data-content)}.grvsc-source{display:table-cell;padding-left:1.5rem;padding-left:var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem));padding-right:1.5rem;padding-right:var(--grvsc-padding-right,var(--grvsc-padding-h,1.5rem))}.grvsc-source:empty::after{content:' ';-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter+.grvsc-source{padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-has-line-highlighting>.grvsc-code>.grvsc-line::before{content:' ';position:absolute;width:100%}.grvsc-line-diff-add::before{background-color:var(--grvsc-line-diff-add-background-color,rgba(0,255,60,.2))}.grvsc-line-diff-del::before{background-color:var(--grvsc-line-diff-del-background-color,rgba(255,0,20,.2))}.grvsc-line-number{padding:0 2px;text-align:right;opacity:.7}.atom-one-light{background-color:#fafafa;color:#383a42}.atom-one-light .mtki{font-style:italic}.atom-one-light .mtk14{color:#a626a4}.atom-one-light .mtk1{color:#383a42}.atom-one-light .mtk9{color:#4078f2}.atom-one-light .mtk8{color:#0184bc}.atom-one-light .mtk5{color:#e45649}.atom-one-light .mtk10{color:#50a14f}.atom-one-light .mtk4{color:#c18401}.atom-one-light .mtk6{color:#986801}.atom-one-light .mtk7{color:#a0a1a7}.atom-one-light .grvsc-line-highlighted::before{background-color:var(--grvsc-line-highlighted-background-color,rgba(0,0,0,.05));box-shadow:inset var(--grvsc-line-highlighted-border-width,4px) 0 0 0 var(--grvsc-line-highlighted-border-color,rgba(0,0,0,.2))}</style><p>Hi everybody! This is my first contribution to the <a href=https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/>F# advent calendar</a> and you'll probably be very surprised to know it will be about... Fable! Yes, the lightweight F# compiler that emits JavaScript you can be proud of (or at least I'll be). This time I want to talk you about one of the exciting new features introduced in <a href=blog/Introducing-0-7.html>Fable 0.7</a>: tree shaking.<hr><p>From the very fist version, Fable compiles F# code to JavaScript using <a href=https://babeljs.io/docs/learn-es2015/>ES2015 features</a> like classes or iterators, and then uses <a href=https://babeljs.io/>Babel</a> (hence the name) to convert the code to something old browsers don't have that much trouble understanding. Among ES2015 features we find a new <a href=http://www.2ality.com/2014/09/es6-modules-final.html>module system</a> that it's been designed to standardize the different solutions that tried to emulate modules in JS so far, like <a href=https://nodejs.org/docs/latest/api/modules.html>commonjs</a> or <a href=http://requirejs.org/docs/whyamd.html>amd</a>. But why create a new standard instead of taking one of existing ones?<p><img alt="How standards proliferate"src=/static/img/blog/standards.png><blockquote><p>Image courtesy of <a href=https://xkcd.com/927/>xkcd.com</a></blockquote><p>Because, both <code>commonjs</code> and <code>amd</code>, in the spirit of the JS language, allow for dynamic module patching so it's difficult to know what you are actually loading until runtime. ES2015 modules are designed so they can be <strong>analyzed statically</strong> (meaning <em>at compile time</em>). This has several applications but it's mostly important for bundlers. Now let's start a digression to talk about bundlers.<p><code>&#60digression></code>The JavaScript ecosystem has grown enormously in recent years and nowadays we can find a library or component for almost anything. However, JS being an interpreted language it has no compiler to link all the source files and loading them with <code>script</code> HTML tags becomes a nightmare in a rapidly changing development environment. Luckily, tools like <a href=https://webpack.github.io/>Webpack</a> can pack all our sources into a single file for easy deployment.<code>&#60/digression></code><p>Bundlers are nice but the obvious gotcha is we need to be careful not to convert our app in a monster of several MB that takes forever to load. Bundlers and tools like <a href=http://lisperator.net/uglifyjs/>UglifyJS</a> try to mitigate this by removing <strong>dead code</strong>, however due to the commented dynamic nature of JS, many times it's not possible to know what it's actually used or not until runtime. Because of this, JS libraries compete to be as small in size as possible by specializing and resolving very specific problems. The result: JS apps with hundreds of dependencies and an ecosystem full of tiny packages where this year a single developer <a href=http://www.theregister.co.uk/2016/03/23/npm_left_pad_chaos/>broke the internet by retiring 11 lines of code from npm</a>.<h2>Individual imports and exports</h2><p><a href=http://rollupjs.org/>Rollup</a> is a bundler that understands ES2015 modules and its author, Rich Harris, can explain much better than me <a href=https://medium.com/@Rich_Harris/small-modules-it-s-not-quite-that-simple-3ca532d65de4#.bwwly4tk3>the problems of small modules</a> and <a href=https://medium.com/@Rich_Harris/tree-shaking-versus-dead-code-elimination-d3765df85c80#.nnofvhkml>the advantages of tree shaking over dead code elimination</a>, but I'll try to summarize them:<p>The killer feature of ES2015 modules is they allow to make <strong>individual exports and imports</strong>. This means you can reference a library without importing the whole package, only the functions you need. And most importantly, library authors are encouraged to structure their code having this in mind. Then, bundlers (and browsers soon) can easily eliminate anything that's not being imported. Consider this simplistic JS project and the generated bundle.<p>maths.js<pre class="atom-one-light grvsc-container"data-index=0 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>square</span><span class=mtk1> ( x ) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> x </span><span class=mtk8>*</span><span class=mtk1> x;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>cube</span><span class=mtk1> ( x ) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> x </span><span class=mtk8>*</span><span class=mtk1> x </span><span class=mtk8>*</span><span class=mtk1> x;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span></code></pre><p>main.js (entry module)<pre class="atom-one-light grvsc-container"data-index=1 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>import</span><span class=mtk1> { </span><span class=mtk5>cube</span><span class=mtk1> } </span><span class=mtk14>from</span><span class=mtk1> </span><span class=mtk10>'./maths.js'</span><span class=mtk1>;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk4>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>( </span><span class=mtk9>cube</span><span class=mtk1>( </span><span class=mtk6>5</span><span class=mtk1> ) ); </span><span class="mtk7 mtki">// 125</span></span></span></code></pre><p>bundle.js (<code>square</code> is excluded)<pre class="atom-one-light grvsc-container"data-index=2 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>cube</span><span class=mtk1> ( x ) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> x </span><span class=mtk8>*</span><span class=mtk1> x </span><span class=mtk8>*</span><span class=mtk1> x;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk4>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>( </span><span class=mtk9>cube</span><span class=mtk1>( </span><span class=mtk6>5</span><span class=mtk1> ) );</span></span></span></code></pre><p>Check Rollup's website to see how this works <a href=http://rollupjs.org/>live</a>.<p>Cool, isn't it? But... wait, what am I doing? I wanted to convince you to try Fable and here I am only talking about the niceties of ES2015 modules. Obviously, it's not possible for Fable to have any advantage regarding a feature that was specifically designed for JS and its ecosystem, right? Well, let's see. Challenge accepted!<h2>Autocompletion</h2><p>ES2015 modules are very nice but there's one little problem: they make <strong>exploratory programming</strong> more difficult. We need to know the bits of the library we want to import in advance, which means we must check the documentation carefully to see what we actually need and we cannot use the tremendously productive autocompletion capabilities of IDEs like <a href=https://code.visualstudio.com/>Visual Studio Code</a> to explore the API as we code. <strong>Not even with TypeScript</strong>, a statically typed language, as it uses the same syntax as ES2015 for importing modules.<p>Enter Fable (finally!). Provided you have a single root module per file, Fable will automatically export your public functions with ES2015 syntax. Check the following code and the generated JS:<pre class="atom-one-light grvsc-container"data-index=3 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>module</span><span class=mtk9> MyNamespace.MyModule</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>foo</span><span class=mtk1> x </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  x </span><span class=mtk14>+</span><span class=mtk1> x</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>bar</span><span class=mtk1> y </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  y </span><span class=mtk14>*</span><span class=mtk1> y</span></span></span></code></pre><pre class="atom-one-light grvsc-container"data-index=4 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>foo</span><span class=mtk1>(x) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> x </span><span class=mtk8>+</span><span class=mtk1> x;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>export</span><span class=mtk1> </span><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>bar</span><span class=mtk1>(y) {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>return</span><span class=mtk1> y </span><span class=mtk8>*</span><span class=mtk1> y;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span></code></pre><p>Noticed that? Fable doesn't create an inner module within <code>MyNamespace</code> but exposes the functions in <code>MyModule</code> directly to make the code compatible with ES2015 bundlers. Let's see how it works when we're consuming the code:<pre class="atom-one-light grvsc-container"data-index=5 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk1>#load </span><span class=mtk10>"MyLib.fs"</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>MyNamespace.MyModule</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk14>private</span><span class=mtk1> </span><span class=mtk5>test</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>result</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> bar </span><span class=mtk6>5</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  printfn </span><span class=mtk10>"</span><span class=mtk14>%i</span><span class=mtk10>"</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>test</span><span class=mtk6>()</span></span></span></code></pre><pre class="atom-one-light grvsc-container"data-index=6 data-language=js><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>import</span><span class=mtk1> { </span><span class=mtk5>fsFormat</span><span class=mtk1> } </span><span class=mtk14>from</span><span class=mtk1> </span><span class=mtk10>"fable-core/String"</span><span class=mtk1>;</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>import</span><span class=mtk1> { </span><span class=mtk5>bar</span><span class=mtk1> } </span><span class=mtk14>from</span><span class=mtk1> </span><span class=mtk10>"./MyLib"</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>function</span><span class=mtk1> </span><span class=mtk9>test</span><span class=mtk1>() {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk14>const</span><span class=mtk1> </span><span class=mtk6>result</span><span class=mtk1> </span><span class=mtk8>=</span><span class=mtk1> </span><span class=mtk9>bar</span><span class=mtk1>(</span><span class=mtk6>5</span><span class=mtk1>);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  </span><span class=mtk9>fsFormat</span><span class=mtk1>(</span><span class=mtk10>"%i"</span><span class=mtk1>)(x </span><span class=mtk14>=></span><span class=mtk1> {</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk4>console</span><span class=mtk1>.</span><span class=mtk8>log</span><span class=mtk1>(x);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>  })(result);</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>}</span></span></span></code></pre><p>Fable is just importing the function we need, the way ES2015 modules are intended to be. The clear difference with raw JS here is we don't need to make the imports explicit: if we replace <code>bar</code> with <code>foo</code> Fable will change the import automatically. As you can see, this works not only for our code but also for functions in <code>fable-core</code> (the JS translation of FSharp.Core).<p>The example was just to show that opening a module doesn't import everything, but in order to get autocompletion we just need to qualify the module name instead. The generated JS code will be the same.<p><img alt=Autocompletion src=/static/img/blog/capture2.png><p>This means we can do exploratory programming while still having all the advantages of tree-shaking: the best of two worlds! (my favourite sentence). And, as you probably know, F# has many tools to write and read documentation directly in code. With <a href=http://ionide.io/>Ionide</a> you even get formatting for markdown comments!<p><img alt=Markdown src=/static/img/blog/capture1.jpg><p>Have I convinced you yet to use the Fable + ES2015 bundler combo? Great! Now you just need to do is to find the right bundler, install it, learn how to configure it, make sure to run it after every Fable compilation... No, wait! <a href=http://fable.io/blog/Introducing-0-7.html#ES2015-Modules-and-Bundling>Fable 0.7 comes with Rollup embedded</a> so the only thing you need to bundle your code and dependencies with tree shaking is:<pre class="atom-one-light grvsc-container"data-index=7 data-language><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source>fable src/MyProject.fsproj --rollup</span></span></code></pre><p>And that's it!<hr><p>Hope you liked the post and give Fable a try. Please check the web and the documentation (being updated to 0.7 at the moment) and come to the <a href=https://gitter.im/fable-compiler/Fable>Gitter channel</a> if you have any question. Also make sure to follow the other posts of the awesome <a href=https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/>F# advent calendar</a> and keep tuned with Fable's website and <a href=https://twitter.com/FableCompiler>Twitter</a> for other exciting announcements!</div></div></div></div></div></div><script async="" src="/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>