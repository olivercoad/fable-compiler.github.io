<html class="has-navbar-fixed-top" lang="en"><head><title>Fable · JS Decorators in Fable 3.3</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/style.css"/><script src="https://unpkg.com/scroll-into-view-if-needed@2.2.28/umd/scroll-into-view-if-needed.min.js"></script></head><body><nav class="navbar is-fixed-top is-spaced"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/">Fable</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/docs">Documentation</a><a class="navbar-item is-hidden-mobile" href="/repl/">Try</a><a class="navbar-item is-active" href="/blog/index.html">Blog</a><a class="navbar-item is-hidden-mobile" href="/community.html">Community</a><a class="navbar-item is-hidden-mobile" href="/resources.html">Resources</a><div class="navbar-item navbar-burger-dots is-hidden-tablet"><svg height="4" stroke="none" viewBox="0 0 22 4" width="22"><circle cx="2" cy="2" r="2"></circle><circle cx="2" cy="2" r="2" transform="translate(9,0)"></circle><circle cx="2" cy="2" r="2" transform="translate(18,0)"></circle></svg></div></div><div class="navbar-end is-hidden-mobile"><a class="navbar-item" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a></div></div><div class="nacara-navbar-menu"><a class="nacara-navbar-menu-item" href="/repl/">Try</a><a class="nacara-navbar-menu-item" href="/community.html">Community</a><a class="nacara-navbar-menu-item" href="/resources.html">Resources</a><a class="nacara-navbar-menu-item" href="https://github.com/fable-compiler/fable">Github</a><a class="nacara-navbar-menu-item" href="https://twitter.com/FableCompiler">Twitter</a><a class="nacara-navbar-menu-item" href="https://gitter.im/fable-compiler/Fable">Gitter</a><a class="nacara-navbar-menu-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos">Youtube</a></div></div></nav><div class="grey-overlay"></div><div class="nacara-content"><div class="container"><div class="columns"><div class="column is-8-desktop is-offset-2-desktop"><div class="section blog-post"><figure class="image is-96x96 author-image"><img class="is-rounded" src="https://github.com/alfonsogarciacaro.png"/></figure><h2 class="title is-size-3 has-text-primary has-text-weight-normal has-text-centered blog-title">JS Decorators in Fable 3.3</h2><div class="tags has-addons is-justify-content-center"><a class="tag is-rounded is-medium is-primary" href="https://twitter.com/alfonsogcnunez">Alfonso García-Caro</a><span class="tag is-rounded is-medium">September 17, 2021</span></div><div class="content"><style class=grvsc-styles>.grvsc-container{overflow:auto;position:relative;-webkit-overflow-scrolling:touch;padding-top:1rem;padding-top:var(--grvsc-padding-top,var(--grvsc-padding-v,1rem));padding-bottom:1rem;padding-bottom:var(--grvsc-padding-bottom,var(--grvsc-padding-v,1rem));border-radius:8px;border-radius:var(--grvsc-border-radius,8px);font-feature-settings:normal;line-height:1.4}.grvsc-code{display:table}.grvsc-line{display:table-row;box-sizing:border-box;width:100%;position:relative}.grvsc-line>*{position:relative}.grvsc-gutter-pad{display:table-cell;padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-gutter{display:table-cell;-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter::before{content:attr(data-content)}.grvsc-source{display:table-cell;padding-left:1.5rem;padding-left:var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem));padding-right:1.5rem;padding-right:var(--grvsc-padding-right,var(--grvsc-padding-h,1.5rem))}.grvsc-source:empty::after{content:' ';-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter+.grvsc-source{padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-has-line-highlighting>.grvsc-code>.grvsc-line::before{content:' ';position:absolute;width:100%}.grvsc-line-diff-add::before{background-color:var(--grvsc-line-diff-add-background-color,rgba(0,255,60,.2))}.grvsc-line-diff-del::before{background-color:var(--grvsc-line-diff-del-background-color,rgba(255,0,20,.2))}.grvsc-line-number{padding:0 2px;text-align:right;opacity:.7}.atom-one-light{background-color:#fafafa;color:#383a42}.atom-one-light .mtk14{color:#a626a4}.atom-one-light .mtk1{color:#383a42}.atom-one-light .mtk9{color:#4078f2}.atom-one-light .mtk4{color:#c18401}.atom-one-light .mtk6{color:#986801}.atom-one-light .mtk5{color:#e45649}.atom-one-light .mtk8{color:#0184bc}.atom-one-light .mtk10{color:#50a14f}.atom-one-light .grvsc-line-highlighted::before{background-color:var(--grvsc-line-highlighted-background-color,rgba(0,0,0,.05));box-shadow:inset var(--grvsc-line-highlighted-border-width,4px) 0 0 0 var(--grvsc-line-highlighted-border-color,rgba(0,0,0,.2))}</style><p>Fable 3.3 is out with several fixes and improvements (like F# interpolated strings compiled as JS templates) but above all, with a new feature that I hope will be put in good use by Fable library authors: JS decorators! Decorators are currently <a href=https://github.com/tc39/proposal-decorators>a proposal</a> to add metaprogramming capabilities to JavaScript. Fable developers have been <a href=https://zaid-ajaj.github.io/Fable.Remoting/>enjoying</a> <a href=https://thoth-org.github.io/Thoth.Json/#Auto-coders>this</a> for a while thanks to the use of Reflection, and decorators will bring even more options to the table.<p>But just to curb your enthusiasm, a couple of caveats for starters:<ul><li><p>Fable JS decorators don't actually compile to JS decorators. Mainly because, as we've just seen, decorators are still a proposal. Code output by Fable is executable now by all modern browsers without any further transformation, and will continue as is.<li><p>Fable JS decorators are inspired by the JS decorator proposal, but it doesn't work exactly the same because of the differences with F# attributes. See details below.</ul><p>What are decorators used for then? Focusing on functions for now, decorators can transform a function on initialization to <em>enhance</em> it in different ways. This is a pattern that is becoming increasingly common in JS frameworks. E.g. to <a href=https://lit.dev/docs/components/defining/>declare web components</a>.<p>"But we can already transform a function in F#. This is what functional programming is about!". I hear you, but there are some limitations to this that became obvious when we were <a href=https://zaid-ajaj.github.io/Feliz/#/Feliz/React/CommonPitfalls>trying to implement React functional components</a>. Among other issues, the F# compiler won't let you create a generic function this way, which made it impossible to create generic React components.<p>Fable 3 <a href=https://fable.io/blog/2020/2020-11-20-Announcing-Nagareyama-3.html#Plugins!>brought plugins back</a> to overcome this. But plugins require advanced knowledge, documentation (ehem) and rely on some compiler internals so the may break in future Fable releases. Decorators solve a similar problem and are much simpler to implement (albeit less powerful that plugins). We'll go through a practical example to learn what can be achieved with them.<h2>Measuring the performance of a function</h2><p>Let's say we want to measure the total time spent in calls to a particular function. Yeah, you can use a profiler or better tooling for that but... well, it's just an example.<p>We start by declaring an attribute that inherits <code>Fable.Core.JS.DecoratorAttribute</code>.<pre class="atom-one-light grvsc-container"data-index=0 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>Fable.Core</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>type</span><span class=mtk1> </span><span class=mtk4>MeasurePerformanceAttribute</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>inherit</span><span class=mtk1> JS.DecoratorAttribute</span><span class=mtk6>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>override</span><span class=mtk1> </span><span class=mtk5>_.Decorate</span><span class=mtk14>(</span><span class=mtk1>fn</span><span class=mtk14>:</span><span class=mtk1> </span><span class=mtk4>JS.Function</span><span class=mtk14>)</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> fn</span></span></span></code></pre><p>This is not doing anything terribly useful, just takes the function and returns it as is so basically no change. Let's modify the <code>Decorate</code> function to measure the time spent when calling the function.<pre class="atom-one-light grvsc-container"data-index=1 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>type</span><span class=mtk1> </span><span class=mtk4>MeasurePerformanceAttribute</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>inherit</span><span class=mtk1> JS.DecoratorAttribute</span><span class=mtk6>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk8>[&#60Emit</span><span class=mtk14>(</span><span class=mtk10>"performance.now()"</span><span class=mtk14>)</span><span class=mtk8>>]</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>member</span><span class=mtk1> </span><span class=mtk5>_.now</span><span class=mtk6>()</span><span class=mtk14>:</span><span class=mtk1> </span><span class=mtk4>float </span><span class=mtk14>=</span><span class=mtk1> jsNative</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>static let mutable</span><span class=mtk1> </span><span class=mtk5>totalTime</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> </span><span class=mtk6>0.</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>override</span><span class=mtk1> </span><span class=mtk5>this.Decorate</span><span class=mtk14>(</span><span class=mtk1>fn</span><span class=mtk14>)</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        JS.spreadFunc</span><span class=mtk14>(fun</span><span class=mtk1> args </span><span class=mtk14>-></span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>t1</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> this.now</span><span class=mtk14>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>res</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> fn.apply</span><span class=mtk14>(</span><span class=mtk6>null</span><span class=mtk14>,</span><span class=mtk1> args</span><span class=mtk14>)</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>t2</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> this.now</span><span class=mtk14>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            totalTime </span><span class=mtk14>&#60-</span><span class=mtk1> totalTime </span><span class=mtk14>+</span><span class=mtk1> </span><span class=mtk14>(</span><span class=mtk1>t2 </span><span class=mtk14>-</span><span class=mtk1> t1</span><span class=mtk14>)</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            res</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        </span><span class=mtk14>)</span></span></span></code></pre><p>We've also added a couple of helpers: a binding to call the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Performance/now>Browser performance API</a> (also available in the Fable.Browser.Performance package for the fully typed bindings), and a value to hold the total time of the function calls. Note this value is static because the decorator attribute will be instantiated once per function decorated and here we're interested in the total time of all the functions... this is JS so we don't have to worry about multiple threads mutating the value!<p>Now let's check the <code>Decorate</code> member. This time we're wrapping the decorated function to get the times before and after the call. Note that we're using <code>JS.spreadFunct</code> to tell Fable this should be a JS function with spread arguments <code>function (...args) {}</code> that we will apply to <code>fn</code>.<p>What's left is to decorate the function we want to modify:<pre class="atom-one-light grvsc-container"data-index=2 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk8>[&#60MeasurePerformance>]</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>myExpensiveCalculation</span><span class=mtk1> x y </span><span class=mtk14>=</span><span class=mtk1> x </span><span class=mtk14>+</span><span class=mtk1> y</span></span></span></code></pre><p>You can also add arguments to the attribute constructor. The values will be accessible from the <code>Decorate</code> function (just remember .NET restricts attributes arguments to literals and types).<pre class="atom-one-light grvsc-container"data-index=3 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk8>[&#60MeasurePerformance</span><span class=mtk14>(</span><span class=mtk10>"a message"</span><span class=mtk14>)</span><span class=mtk8>>]</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>myExpensiveCalculation</span><span class=mtk1> x y </span><span class=mtk14>=</span><span class=mtk1> x </span><span class=mtk14>+</span><span class=mtk1> y</span></span></span></code></pre><p>You're probably thinking that since Heisenberg we know measuring performance <em>affects</em> performance. It's a good idea to disable this decorator in production. We can do that by using compilation directives.<pre class="atom-one-light grvsc-container"data-index=4 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>type</span><span class=mtk1> </span><span class=mtk4>MeasurePerformanceAttribute</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>#if </span><span class=mtk14>!</span><span class=mtk1>DEBUG</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>inherit</span><span class=mtk1> System.Attribute</span><span class=mtk6>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>#else</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>inherit</span><span class=mtk1> JS.DecoratorAttribute</span><span class=mtk6>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>override</span><span class=mtk1> </span><span class=mtk5>this.Decorate</span><span class=mtk14>(</span><span class=mtk1>fn</span><span class=mtk14>)</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> </span><span class=mtk14>..</span><span class=mtk1>.</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>#endif</span></span></span></code></pre><p>By default, Fable erases attributes so this won't affect the runtime when compiling in Release mode.<p>If you need more information about the function, inherit <code>JS.ReflectedDecoratorAttribute</code> instead. With this the <code>Decorate</code> method will also receive the reflected <code>MethodInfo</code> about the function. Just remember Fable supports .NET reflection <em>partially</em>. Fable 3.3 supports the following API:<ul><li>MethodInfo.Name<li>MethodInfo.ReturnType<li>MethodInfo.GetParameters()<li>ParameterInfo.Name<li>ParameterInfo.ParameterType</ul><pre class="atom-one-light grvsc-container"data-index=5 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>type</span><span class=mtk1> </span><span class=mtk4>LogAttribute</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>inherit</span><span class=mtk1> JS.ReflectedDecoratorAttribute</span><span class=mtk6>()</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>override</span><span class=mtk1> </span><span class=mtk5>_.Decorate</span><span class=mtk14>(</span><span class=mtk1>fn</span><span class=mtk14>,</span><span class=mtk1> info</span><span class=mtk14>)</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        printfn $</span><span class=mtk10>"Decorating function {info.Name}: {info.ReturnType}"</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        </span><span class=mtk14>for</span><span class=mtk1> p </span><span class=mtk14>in</span><span class=mtk1> info.GetParameters</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>do</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            printfn $</span><span class=mtk10>"> {p.Name}: {p.ParameterType}"</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        fn</span></span></span></code></pre><p>That's all folks! I'm looking forward to seeing the great things Fable contributors will build with this new tool in their hands. Please do share with the community by mentioning @FableCompiler in Twitter. Have f#un!</div></div></div></div></div></div><script async="" src="/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>